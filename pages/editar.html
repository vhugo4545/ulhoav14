<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Proposta com Inputs e Tabela</title>

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />
  <link rel="stylesheet" href="../css/listagem.css" />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

</head>



<body>
  
<script>
  // Overlay simples de carregamento (4s)
  function mostrarOverlayCarregando(duracaoMs = 4000) {
    // evita duplicar
    if (document.getElementById("vv-loading-overlay")) return;

    const overlay = document.createElement("div");
    overlay.id = "vv-loading-overlay";
    overlay.setAttribute("role", "status");
    overlay.setAttribute("aria-live", "polite");
    overlay.innerHTML = `
      <div style="
        display:flex; flex-direction:column; align-items:center; justify-content:center;
        gap:10px; text-align:center;
      ">
        <div style="
          width:42px; height:42px; border:4px solid rgba(255,255,255,.35);
          border-top-color:#fff; border-radius:50%;
          animation: vvSpin 0.85s linear infinite;
        "></div>
        <div style="font: 600 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial; color:#fff;">
          Carregando...
        </div>
      </div>
    `;

    // estilo do overlay (inline pra ser direto)
    overlay.style.cssText = `
      position: fixed;
      inset: 0;
      z-index: 999999;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(3px);
    `;

    // keyframes do spinner
    const style = document.createElement("style");
    style.id = "vv-loading-overlay-style";
    style.textContent = `
      @keyframes vvSpin { to { transform: rotate(360deg); } }
    `;

    document.head.appendChild(style);
    document.body.appendChild(overlay);

    setTimeout(() => {
      overlay.remove();
      const s = document.getElementById("vv-loading-overlay-style");
      if (s) s.remove();
    }, duracaoMs);
  }

  // Exemplo de uso:
  // mostrarOverlayCarregando(); // 4s
  mostrarOverlayCarregando(); 
</script>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <ul>
    
      <li><a href="../pages/listagem.html"><span class="material-icons-outlined">list</span> In√≠cio</a></li>
     
    </ul>
<div class="sidebar-footer">
 

  <button id="btn-criar" class="sidebar-button" onclick="salvarPropostaEditavel() " style="display: block;">
      <span class="material-icons-outlined">add_circle_outline</span> Criar Propostaa
    </button>
    
 <div class="sidebar-footer">
  <button id="btn-destravar" class="sidebar-button" onclick="destravarCampos()">
    <span class="material-icons-outlined">lock_open</span><br> Destravar Campos
  </button>
</div>


<script>
function destravarCampos() {
    document.querySelectorAll('input[readonly]').forEach(campo => {
        campo.removeAttribute('readonly'); // Remove o readonly
        campo.style.background = ''; // Restaura a cor padr√£o
    });
}
</script>


<button id="btn-planilha-custos" class="sidebar-button" onclick="gerarPlanilhaCustos()">
  <span class="material-icons-outlined">table_chart</span><br><P></P>Planilha de Custos
</button>
<!-- Teste git -->

 <button id="btn-editar" class="sidebar-button" onclick="atualizarPropostaEditavel() ">
    <span class="material-icons-outlined">edit</span> Editar Proposta ( Atualizar )
  </button>
  
  <button id="btn-solicitar" class="sidebar-button" onclick="marcarPendenteAprovacao()">
    <span class="material-icons-outlined">assignment_turned_in</span><br> Solicitar Aprova√ß√£o
  </button>

  <button id="btn-autorizar" class="sidebar-button" onclick="marcarAprovadoPeloGestor()">
    <span class="material-icons-outlined">verified_user</span><br>  Autorizar Proposta
  </button>

 <button id="btn-visualizar-proposta" class="sidebar-button" onclick="gerarOrcamentoParaImpressaoCompleta()">
  <span class="material-icons-outlined">visibility</span><br><P></P>  Visualizar Proposta
</button>



  <button id="btn-enviar-cliente" class="sidebar-button" onclick="marcarEnviadoParaCliente()">
    <span class="material-icons-outlined">send</span><br> Enviar Proposta
  </button>

  <button id="btn-aprovado-cliente" class="sidebar-button" onclick="marcarAprovadoPeloCliente()">
    <span class="material-icons-outlined">check_circle</span><br>  Aprovado pelo Cliente
  </button>

  <button id="btn-gerar-pedido" class="sidebar-button" onclick="atualizarNaOmie()">
    <span class="material-icons-outlined">receipt_long</span><br> Gerar Pedido de Venda
  </button>

  <button id="btn-atualizar-precos" class="sidebar-button" onclick="atualizarPrecosOmieNaDOM()">
    <span class="material-icons-outlined">sync</span><br>  Atualizar Pre√ßos da Omie
  </button>


  <button id="btn-enviar-cliente" class="sidebar-button" 
        onclick="openOsPopup({ endpoint: 'https://ulhoa-servico-ec4e1aa95355.herokuapp.com/os' })">
  <span class="material-icons-outlined">send</span><br> Modulo de Servi√ßos
</button>

<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#f6f7fb; margin:0; padding:24px; }
  .btn { padding:10px 16px; border:none; border-radius:10px; cursor:pointer; font-weight:600; }
  .btn-primary { background:#2563eb; color:#fff; }
  .btn-secondary { background:#e5e7eb; }
  pre { background:#0b1020; color:#d1e7ff; padding:12px; border-radius:12px; overflow:auto; }

  /* Popup */
  .os-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999;padding:16px}
  .os-modal{width:100%;max-width:720px;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:18px;max-height:95vh;overflow:auto}
  .os-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .os-input{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;font:14px system-ui}
  .os-label{font:600 13px system-ui;color:#111;margin-bottom:6px;display:block}
  .os-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
  .os-btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font:600 14px system-ui}
  .os-btn-primary{background:#2563eb;color:#fff}
  .os-btn-secondary{background:#e5e7eb}
  .os-card{border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:12px}
  .os-title{font:600 16px system-ui;margin:0 0 8px}
  .os-muted{font:12px system-ui;color:#6b7280}
</style>

<script>
let CLIENTES_CACHE = [];

// pr√©-carregar clientes assim que a p√°gina abrir
async function carregarClientesNaAbertura() {
  try {
    const resp = await fetch("https://ulhoa-servico-ec4e1aa95355.herokuapp.com/clientes");
    const data = await resp.json();
    if (data && Array.isArray(data.clientes)) {
      CLIENTES_CACHE = data.clientes;
      console.log("‚úÖ Clientes pr√©-carregados:", CLIENTES_CACHE.length);
    } else {
      console.warn("‚ö†Ô∏è Resposta inesperada da rota /clientes:", data);
    }
  } catch (err) {
    console.error("‚ùå Erro ao carregar clientes:", err);
  }
}
window.addEventListener("DOMContentLoaded", carregarClientesNaAbertura);

// fun√ß√£o para buscar c√≥digo Omie pela raz√£o social no cache
function getCodigoClientePorRazao(razaoSocial) {
  if (!CLIENTES_CACHE.length) {
    console.warn("‚ö†Ô∏è Clientes ainda n√£o carregados, retornando fallback.");
    return "cliente n√£o compartilhado entre bases";
  }
  const encontrado = CLIENTES_CACHE.find(c =>
    String(c.nome_fantasia || "").toLowerCase().includes(razaoSocial.toLowerCase())
  );
  return encontrado ? encontrado.codigo_cliente_omie : "cliente n√£o compartilhado entre bases";
}

async function openOsPopup({ endpoint = "https://ulhoa-servico-ec4e1aa95355.herokuapp.com/os" } = {}) {
  const ENDPOINT = endpoint;
  const $ = (sel, root=document) => root.querySelector(sel);

  // helpers
  function brlToNumber(v){ if(typeof v!=="string") return Number(v)||0; return Number(v.replace(/\./g,"").replace(",", "."))||0; }
  function numberToBRL(n){ return (new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n||0))).replace("R$","").trim(); }
  function parseMoneyLoose(txt){
    if(!txt) return 0;
    let s=String(txt).replace(/[^\d.,-]/g,"");
    const last=Math.max(s.lastIndexOf(","), s.lastIndexOf("."));
    let i=s,f=""; if(last>=0){ i=s.slice(0,last); f=s.slice(last+1); }
    i=i.replace(/[^\d-]/g,""); f=f.replace(/[^\d]/g,"");
    const num=Number(i+(f? "."+f:"")); return isNaN(num)?0:num;
  }

  // pega valores da p√°gina
  const orcEl = document.getElementById("numeroOrcamento");
  const cCodIntOSValue =
    (orcEl?.value && String(orcEl.value).trim()) ||
    (orcEl?.dataset?.valorOriginal && String(orcEl.dataset.valorOriginal).trim()) || "";

  // pega raz√£o social e busca c√≥digo Omie no cache
  const razaoEl = document.querySelector("input.form-control.razaoSocial");
  const razaoSocialValue =
    (razaoEl?.value && String(razaoEl.value).trim()) ||
    (razaoEl?.dataset?.valorOriginal && String(razaoEl.dataset.valorOriginal).trim()) || "";

  let nCodCliValue = "cliente n√£o compartilhado entre bases";
  if (razaoSocialValue) {
    nCodCliValue = getCodigoClientePorRazao(razaoSocialValue);
  }

  const valorFinalTxt = $("#valorFinalTotal")?.textContent?.trim() || "R$ 0,00";
  const valorTotalNum = parseMoneyLoose(valorFinalTxt);
  const prefillValor  = numberToBRL(valorTotalNum);

  // monta popup
  const backdrop = document.createElement("div");
  backdrop.className = "os-backdrop";
  Object.assign(backdrop.style, {
    position:"fixed", inset:"0", background:"rgba(0,0,0,.45)",
    display:"flex", alignItems:"center", justifyContent:"center",
    zIndex:"9999", padding:"16px"
  });
  backdrop.setAttribute("aria-hidden","true");

  backdrop.innerHTML = `
    <div class="os-modal" role="dialog" aria-modal="true" aria-labelledby="os-title"
         style="width:100%;max-width:720px;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:18px;max-height:95vh;overflow:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 class="os-title" id="os-title" style="font:600 16px system-ui">M√≥dulo de Servi√ßos</h3>
        <button class="os-btn os-btn-secondary" id="os-close" type="button"
                style="padding:10px 14px;border-radius:10px;border:none;background:#e5e7eb;cursor:pointer;font:600 14px system-ui">Fechar</button>
      </div>

      <!-- Cabe√ßalho -->
      <div class="os-row">
        <div>
          <label class="os-label">N√∫mero do or√ßamento (cCodIntOS)</label>
          <input class="os-input" id="os-cCodIntOS" value="${cCodIntOSValue}">
        </div>
        <div>
          <label class="os-label">C√≥digo do cliente (nCodCli)</label>
          <input class="os-input" id="os-nCodCli" value="${nCodCliValue}">
        </div>
      </div>

      <div class="os-row" style="margin-top:12px">
        <div>
          <label class="os-label">Quantidade de parcelas (nQtdeParc)</label>
          <input class="os-input" id="os-nQtdeParc" type="number" min="1" step="1" value="1">
        </div>
        <div>
          <label class="os-label">Data de previs√£o (DD/MM/AAAA) (dDtPrevisao)</label>
          <input class="os-input" id="os-dDtPrevisao" value="14/09/2025">
        </div>
      </div>

      <div style="margin-top:12px">
        <label class="os-label">Observa√ß√µes da NF (cDadosAdicNF)</label>
        <input class="os-input" id="os-cDadosAdicNF" value="OS inclu√≠da via API ‚Ä¢ Or√ßamento ${cCodIntOSValue}">
      </div>

      <!-- Servi√ßo -->
      <div class="os-card">
        <div class="os-title">Servi√ßo (valor final com desconto)</div>
        <div class="os-muted">Ser√° enviado 1 item em <code>ServicosPrestados</code> com <b>nQtde = 1</b> e <b>nValUnit = Valor final</b>.</div>

        <div class="os-row" style="margin-top:10px">
          <div>
            <label class="os-label">Valor total (R$)</label>
            <input class="os-input" id="os-valorTotal" inputmode="decimal" value="${prefillValor}">
          </div>
          <div>
            <label class="os-label">Desconto (%)</label>
            <input class="os-input" id="os-percent" type="number" step="0.01" value="0">
          </div>
        </div>

        <div class="os-row" style="margin-top:10px">
          <div>
            <label class="os-label">Valor final (R$)</label>
            <input class="os-input" id="os-resultado" readonly>
          </div>
          <div>
            <label class="os-label">Quantidade do servi√ßo (nQtde)</label>
            <input class="os-input" id="os-s2nQtde" type="number" min="1" value="1" readonly>
          </div>
        </div>
      </div>

      <div class="os-actions">
        <button class="os-btn os-btn-secondary" id="os-cancel" type="button">Cancelar</button>
        <button class="os-btn os-btn-primary" id="os-submit" type="button">Enviar OS</button>
      </div>
    </div>
  `;
  document.body.appendChild(backdrop);

  // acessibilidade/controle
  function show(){ backdrop.style.display="flex"; backdrop.setAttribute("aria-hidden","false"); }
  function hide(){ backdrop.style.display="none"; backdrop.setAttribute("aria-hidden","true"); }
  function cleanup(){ try{backdrop.remove()}catch{} }
  show();

  // refs
  const btnClose   = $("#os-close", backdrop);
  const btnCancel  = $("#os-cancel", backdrop);
  const btnSubmit  = $("#os-submit", backdrop);

  const inpCodInt  = $("#os-cCodIntOS", backdrop);
  const inpCli     = $("#os-nCodCli", backdrop);
  const inpParc    = $("#os-nQtdeParc", backdrop);
  const inpData    = $("#os-dDtPrevisao", backdrop);
  const inpAdicNF  = $("#os-cDadosAdicNF", backdrop);

  const inpTotal   = $("#os-valorTotal", backdrop);
  const inpPercent = $("#os-percent", backdrop);
  const inpRes     = $("#os-resultado", backdrop);
  const inpS2Qtde  = $("#os-s2nQtde", backdrop);

  // c√°lculo: valor final = total - desconto(%)
  function calc(){
    const base = brlToNumber(inpTotal.value);
    const p = Number(inpPercent.value)||0;
    const final = base * (1 - p/100);
    inpRes.value = numberToBRL(final);
  }
  inpTotal.addEventListener("input", calc);
  inpPercent.addEventListener("input", calc);
  calc();

  // fechar
  const closeAll = () => { hide(); cleanup(); };
  btnClose.onclick = closeAll;
  btnCancel.onclick = closeAll;
  backdrop.addEventListener("keydown", e => { if(e.key==="Escape") closeAll(); });

  // enviar
  btnSubmit.onclick = async () => {
    const missing = [];
    if (!inpCodInt.value)            missing.push("N√∫mero do or√ßamento (cCodIntOS)");
    if (!inpData.value)              missing.push("Data de previs√£o (dDtPrevisao)");
    if (!inpCli.value || inpCli.value === "cliente n√£o compartilhado entre bases") missing.push("C√≥digo do cliente (nCodCli)");
    if (!(Number(inpParc.value) > 0))missing.push("Quantidade de parcelas (nQtdeParc)");

    const nValUnitFinal = brlToNumber(inpRes.value || "0");
    if (!(nValUnitFinal > 0)) missing.push("Valor final (R$)");

    if (missing.length) {
      alert("Preencha: " + missing.join(", "));
      return;
    }

    const payload = {
      Cabecalho: {
        cCodIntOS: String(inpCodInt.value).trim(),
        cCodParc: "999",
        cEtapa: "20",
        dDtPrevisao: String(inpData.value).trim(),
        nCodCli: Number(inpCli.value),
        nQtdeParc: Number(inpParc.value)
      },
      Departamentos: [],
      Email: { cEnvBoleto:"N", cEnvLink:"N", cEnviarPara:"" },
      InformacoesAdicionais: {
        cCodCateg: "1.02.02",
        cDadosAdicNF: String(inpAdicNF.value).trim(),
        nCodCC: 10937506623
      },
      ServicosPrestados: [
        {
          cCodServLC116: "7.01",
          cCodServMun:   "0701-0/01-88",
          cRetemISS:     "N",
          cTribServ:     "01",
          impostos: { cRetemIRRF:"N", cRetemPIS:"N", nAliqIRRF:0, nAliqISS:0, nAliqPIS:0 },
          nQtde: 1,
          nValUnit: nValUnitFinal
        }
      ]
    };

    try {
      const resp = await fetch(ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      const out = document.getElementById("saida");
      if (out) out.textContent = JSON.stringify(data, null, 2);
      alert(data.ok ? "OS enviada com sucesso!" : ("Falha: " + (data.error || "Erro")));
      closeAll();
    } catch (err) {
      const out = document.getElementById("saida");
      if (out) out.textContent = "Erro de conex√£o: " + (err?.message || err);
      alert("Erro de conex√£o com o servidor.");
      closeAll();
    }
  };
}
</script>






</div>



<script>
  function redirecionarParaEdicao() {
    const id = new URLSearchParams(location.search).get("id");
    window.location.href = "editar.html?id=" + "68746e305b9691a7ed3b3f97";
  }
</script>


  </aside>



  <!-- CONTE√öDO PRINCIPAL -->
  <main class="content">
    <div class="main-container">
      <form id="novoOrcamentoForm">
        <div class="accordion mb-3" id="accordionOrcamento">

          <!-- Aba: Informa√ß√µes do Or√ßamento -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseInfoOrcamento">
                Informa√ß√µes do Or√ßamento
              </button>
            </h2>
            <div id="collapseInfoOrcamento" class="accordion-collapse collapse show">
              <div class="accordion-body">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label">N√∫mero do Or√ßamento</label>
                    <input type="text" class="form-control" id="numeroOrcamento" readonly tabindex="-1"
                      style="background-color: #e6e6e6; color: #000;">
                  </div>

                  <div class="col-md-4">
                    <label class="form-label">Data do Or√ßamento</label>
                    <input type="date" class="form-control" id="dataOrcamento" required>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Origem do Cliente</label>
                    <select class="form-select" id="origemCliente" required>
                      <option value="">Selecione</option>
                      <option>Arquiteto(a)</option>
                      <option>Construtora</option>
                      <option>Engenheiro(a)</option>
                      <option>Google</option>
                      <option>Instagram</option>
                      <option>Indica√ß√£o</option>
                      <option>J√° √© cliente</option>
                      <option>Licita√ß√£o</option>
                      <option>Outros</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Aba: Dados do Cliente -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseCliente">
                Dados do Cliente
              </button>
            </h2>
            <div id="collapseCliente" class="accordion-collapse collapse">
              <div class="accordion-body">
                <div id="clientesWrapper">
                  <div class="row g-3 cliente-item">
                    <div class="col-md-6 position-relative d-flex align-items-end gap-2">
                      <div class="flex-grow-1">
                        <label class="form-label">Nome / Raz√£o Social</label>
                        <input type="text" class="form-control razaoSocial" placeholder="Digite para buscar..."
                          autocomplete="off">
                        <ul class="sugestoesCliente list-group position-absolute w-100 shadow bg-white"
                          style="z-index: 10; max-height: 200px; overflow-y: auto; display: none;"></ul>
                      </div>
                      <button type="button" class="btn btn-outline-success rounded-circle" title="Incluir Cliente"
                        onclick="abrirPopupIncluirCliente()"
                        style="height: 38px; width: 38px; display: flex; align-items: center; justify-content: center;">
                        <strong>+</strong>
                      </button>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">C√≥digo Omie</label>
                      <input type="text" class="form-control codigoCliente" readonly
                        style="background-color: #dfdfe0; color: #000;">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">CPF / CNPJ</label>
                      <input type="text" class="form-control cpfCnpj" required>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Nome do Contato</label>
                      <input type="text" class="form-control nomeContato">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Fun√ß√£o</label>
                      <input type="text" class="form-control funcaoCliente">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Telefone</label>
                      <input type="text" class="form-control telefoneCliente">
                    </div>
                  </div>
                </div>
                <button type="button" class="btn btn-outline-primary mt-2"
                  onclick="adicionarClienteRelacionado()">Adicionar Cliente Relacionado</button>
                  <button type="button" class="btn btn-outline-danger btn-sm" onclick="abrirPopupExcluirClienteRelacionado()">
  Excluir cliente relacionado
</button>

              </div>
            </div>
          </div>

          <!-- Aba: Endere√ßo da Obra -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseEndereco">
                Endere√ßo da Obra
              </button>
            </h2>
            <div id="collapseEndereco" class="accordion-collapse collapse">
              <div class="accordion-body">
                <div class="row g-3">
                  <div class="col-md-3"><label class="form-label">CEP</label><input type="text" class="form-control"
                      id="cep"></div>
                  <div class="col-md-6"><label class="form-label">Rua / Avenida</label><input type="text"
                      class="form-control" id="rua"></div>
                  <div class="col-md-3"><label class="form-label">N√∫mero</label><input type="text" class="form-control"
                      id="numero"></div>
                  <div class="col-md-4"><label class="form-label">Complemento</label><input type="text"
                      class="form-control" id="complemento"></div>
                  <div class="col-md-4"><label class="form-label">Bairro</label><input type="text" class="form-control"
                      id="bairro"></div>
                  <div class="col-md-2"><label class="form-label">Cidade</label><input type="text" class="form-control"
                      id="cidade"></div>
                  <div class="col-md-2"><label class="form-label">Estado</label><input type="text" class="form-control"
                      id="estado"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Aba: Equipe Interna -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseEquipe">
                Equipe Interna
              </button>
            </h2>
            <div id="collapseEquipe" class="accordion-collapse collapse">
              <div class="accordion-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Vendedor Respons√°vel</label>
                    <select class="form-select" id="vendedorResponsavel" required>
                      <option value="">Carregando...</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Operador (Usu√°rio Interno)</label>
                    <input type="text" class="form-control" id="operadorInterno">
                  </div>
                </div>
                 <!-- Bot√£o Hist√≥rico -->
      <div class="mt-3">
        <button id="btn-historico-mudancas" type="button" class="btn btn-warning w-100" onclick="toggleTabelaHistorico()">
          üìã Ver Hist√≥rico de Altera√ß√µes
        </button>
      </div>

              </div>
            </div>
          </div>

          <!-- Aba: Produtos, Condi√ß√µes e Prazos -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseProdutos">
                Produtos, Prazos e Condi√ß√µes
              </button>
            </h2>
            <div id="collapseProdutos" class="accordion-collapse collapse">
              <div class="accordion-body">
                <div class="mb-3">
                  <label class="form-label">Prazos por √Årea</label>
                  <textarea class="form-control" id="prazosArea" rows="5"
                    placeholder="√Årea ___: ___ dias √∫teis ap√≥s aprova√ß√£o..."></textarea>
                </div>

                <div class="mb-3">
                  <label class="form-label">Condi√ß√£o de Pagamento</label>
                  <select class="form-select" id="condicaoPagamento">
                    <option value="">Selecione</option>
                    <option value="debito">40% de entrada, 40% ap√≥s 30 dias e 20% ap√≥s 60 dias.</option>
                    <option value="debito">40% de entrada, 30% ap√≥s 30 dias e 30% ap√≥s 60 dias.</option>
                    <option value="debito">60% de entrada, 40% ap√≥s 30 dias.</option>
                    <option value="parcelado">Personalizado</option>
                  </select>
                </div>

                <div id="parcelamentoContainer" style="display: none;">
                  <label class="form-label">Parcelas</label>
                  <div id="listaParcelas"></div>
                  <strong>Total das parcelas: <span id="totalParcelas">R$ 0,00</span></strong>
                  <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="adicionarParcela()">+ Adicionar
                    Parcela</button>
                </div>

                <div class="mb-3 mt-3">
                  <label class="form-label">Condi√ß√µes Gerais</label>
                  <div class="d-flex flex-wrap gap-2 mb-2">
                    <button type="button" class="btn btn-outline-primary"
                      onclick="preencherCondicoesComInstalacao()">Com medi√ß√£o e instala√ß√£o</button>
                    <button type="button" class="btn btn-outline-secondary"
                      onclick="preencherCondicoesSemInstalacao()">Sem medi√ß√£o e instala√ß√£o</button>
                    <button type="button" class="btn btn-outline-warning" onclick="preencherCondicoesSemTampo()">Sem
                      tampo</button>
                      <button type="button" class="btn btn-outline-dark"
  onclick="preencherCondicoesGeraisComDiagramacao()">Descritivo contratual</button>

                  </div>
                  <textarea class="form-control" id="condicoesGerais" rows="10"
                    placeholder="Escolha uma op√ß√£o ou edite manualmente..."></textarea>
                </div>

              </div>
            </div>
          </div>

<!-- Aba NOVA: Acompanhamento (Pedido/Obra/Projeto) -->
<div class="accordion-item">
  <h2 class="accordion-header" id="headingAbaObraPedido">
    <button class="accordion-button collapsed" type="button"
      data-bs-toggle="collapse"
      data-bs-target="#collapseAbaObraPedido"
      aria-expanded="false"
      aria-controls="collapseAbaObraPedido">
      Acompanhamento do Pedido, Obra e Projeto
    </button>
  </h2>

  <div id="collapseAbaObraPedido"
    class="accordion-collapse collapse"
    aria-labelledby="headingAbaObraPedido"
    data-bs-parent="#accordionProposta">
    <div class="accordion-body">

      <div class="mb-3">
        <label class="form-label">Prazo de entrega</label>
        <input type="text" class="form-control" id="prazoEntrega" placeholder="Ex.: 20 dias √∫teis ap√≥s aprova√ß√£o">
      </div>

      <div class="mb-3">
        <label class="form-label">Data que o pedido foi enviado para o cliente</label>
        <input type="date" class="form-control" id="dataPedidoEnviadoCliente">
      </div>

      <div class="mb-3">
        <label class="form-label">Por onde foi enviado</label>
        <input type="text" class="form-control" id="meioEnvioPedido" placeholder="Ex.: WhatsApp, e-mail, presencial...">
      </div>

      <div class="mb-3">
        <label class="form-label">Data que o pedido foi assinado</label>
        <input type="date" class="form-control" id="dataPedidoAssinado">
      </div>

      <div class="mb-3">
        <label class="form-label">Obra est√° liberada?</label>
        <select class="form-select" id="obraLiberada">
          <option value="">Selecione</option>
          <option value="sim">Sim</option>
          <option value="nao">N√£o</option>
          <option value="parcial">Parcial</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Quais itens / observa√ß√µes sobre a libera√ß√£o</label>
        <textarea class="form-control" id="itensLiberacaoObra" rows="4"
          placeholder="Descreva quais itens est√£o liberados, pend√™ncias, restri√ß√µes, etc."></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">Data da libera√ß√£o da obra</label>
        <input type="date" class="form-control" id="dataLiberacaoObra">
      </div>

      <div class="mb-3">
        <label class="form-label">Data do projeto enviado</label>
        <input type="date" class="form-control" id="dataProjetoEnviado">
      </div>

      <div class="mb-3">
        <label class="form-label">Data do projeto assinado</label>
        <input type="date" class="form-control" id="dataProjetoAssinado">
      </div>

      <div class="mb-3">
        <label class="form-label">Data da medi√ß√£o realizada</label>
        <input type="date" class="form-control" id="dataMedicaoRealizada">
      </div>

    </div>
  </div>
</div>


        </div>
      </form>
      <div class="d-flex justify-content-center my-4 position-relative">
        <div class="d-flex flex-column align-items-center w-100" style="max-width: 600px;">
          <div class="input-group input-group-lg shadow w-100">
            <input id="buscaProduto" type="text" class="form-control text-center" placeholder="Pesquisar produto, cliente ou proposta..." autocomplete="off">
            <button class="btn btn-primary d-flex align-items-center gap-2 px-4" type="button">
              <span class="material-icons-outlined">search</span>
              <span>Buscar</span>
            </button>
          </div>

          <button id="fecharSanfonasBtn" class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="fecharTodasSanfonas()">
            üîΩ Fechar todos os blocos
          </button>

          <button id="abrirSanfonasBtn" class="btn btn-outline-primary btn-sm w-100 mt-2" onclick="abrirTodasSanfonas()">
            üîº Abrir todos os blocos
          </button>



          <ul id="sugestoesProdutos" class="list-group position-absolute w-100 shadow bg-white mt-2" style="z-index: 10; top: 100%; display: block; max-height: 200px; overflow-y: auto;"><li class="list-group-item list-group-item-action" style="cursor: pointer;">Guarda Corpo - Prote√ß√£o</li><li class="list-group-item list-group-item-action" style="cursor: pointer;">Guarda Corpo - Montante H</li><li class="list-group-item list-group-item-action" style="cursor: pointer;">Guarda Corpo - Calha Infinity</li><li class="list-group-item list-group-item-action" style="cursor: pointer;">Guarda Corpo - Bot√£o</li><li class="list-group-item list-group-item-action" style="cursor: pointer;">Guarda Corpo - Garra</li><li class="list-group-item list-group-item-action" style="cursor: pointer;">Guarda Corpo - Calha Ferreira Ulhoa</li><li class="list-group-item list-group-item-action" style="cursor: pointer;">Guarda Corpo - Canaleta</li><li class="list-group-item list-group-item-action" style="cursor: pointer;">Guarda Corpo - Spider</li><li class="list-group-item list-group-item-action" style="cursor: pointer;">Fechamento Frontal</li><li class="list-group-item list-group-item-action" style="cursor: pointer;">Pergolado</li><li class="list-group-item list-group-item-action" style="cursor: pointer;">Porta / Port√£o / Portinhola</li><li class="list-group-item list-group-item-action" style="cursor: pointer;">Corrim√£o</li><li class="list-group-item list-group-item-action" style="cursor: pointer;">Perfil U</li><li class="list-group-item list-group-item-action" style="cursor: pointer;">Revestimento</li><li class="list-group-item list-group-item-action" style="cursor: pointer;">Espera</li><li class="list-group-item list-group-item-action" style="cursor: pointer;">Instala√ß√£o</li><li class="list-group-item list-group-item-action" style="cursor: pointer;">Vidro</li></ul>
        </div>
      </div>
<br>
<br>
<br>

      <div class="col-lg-12" id="blocosProdutosContainer">
        <!-- Blocos din√¢micos de produtos ser√£o adicionados aqui -->
      </div>
    </div>
    
    <br>
    <br>
    <br>
    <br>
    <div id="loader-overlay"
      style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999; background-color:rgba(255,255,255,0.7); justify-content:center; align-items:center;">
      <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div>
    </div>


  </main>

<div class="modal fade" id="popupClienteModal" tabindex="-1" aria-labelledby="popupClienteLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="popupClienteLabel">Incluir Cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <form id="popupCliente_form">
          <div class="mb-3 d-none">
            <label class="form-label">C√≥digo de Integra√ß√£o</label>
            <input type="text" class="form-control" id="popupCliente_codigo" readonly>
          </div>

          <div class="row">
            <div class="mb-3 col-md-6">
              <label class="form-label">Raz√£o Social</label>
              <input type="text" class="form-control" id="popupCliente_razao" required>
            </div>

            <div class="mb-3 col-md-6">
              <label class="form-label">Nome Fantasia</label>
              <input type="text" class="form-control" id="popupCliente_fantasia" required>
            </div>
          </div>

          <div class="row">
            <div class="mb-3 col-md-6">
              <label class="form-label">E-mail</label>
              <input type="email" class="form-control" id="popupCliente_email" required>
            </div>

            <div class="mb-3 col-md-6">
              <label class="form-label">CNPJ ou CPF</label>
              <input type="text" class="form-control" id="popupCliente_cnpjcpf" required>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Endere√ßo</label>
            <input type="text" class="form-control" id="popupCliente_endereco" required>
          </div>

          <div class="row">
            <div class="mb-3 col-md-6">
              <label class="form-label">Bairro</label>
              <input type="text" class="form-control" id="popupCliente_bairro" required>
            </div>

            <div class="mb-3 col-md-6">
              <label class="form-label">Cidade</label>
              <input type="text" class="form-control" id="popupCliente_cidade" required>
            </div>
          </div>

          <div class="row">
            <div class="mb-3 col-md-6">
              <label class="form-label">Estado (UF)</label>
              <input type="text" class="form-control" id="popupCliente_estado" maxlength="2" required>
            </div>

            <div class="mb-3 col-md-6">
              <label class="form-label">CEP</label>
              <input type="text" class="form-control" id="popupCliente_cep" required>
            </div>
          </div>

          <div class="row">
            <div class="mb-3 col-md-6">
              <label class="form-label">Contato</label>
              <input type="text" class="form-control" id="popupCliente_contato">
            </div>

            <div class="mb-3 col-md-6">
              <label class="form-label">Inscri√ß√£o Municipal</label>
              <input type="text" class="form-control" id="popupCliente_inscricao_municipal">
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Inscri√ß√£o Estadual</label>
            <input type="text" class="form-control" id="popupCliente_inscricao_estadual">
          </div>

        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" onclick="enviarClienteParaAPI()">Salvar Cliente</button>
      </div>
    </div>
  </div>
</div>



  <div id="overlayPopup"
    style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background-color:rgba(0,0,0,0.5); z-index:9998;">
  </div>

  <!-- Popup centralizado -->
  <div id="popupPendencias"
    style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,0.3); z-index:9999; max-width:400px;">
    <h5 class="mb-3">‚ö†Ô∏è Pend√™ncias Encontradas</h5>
    <ul id="listaPendencias" class="mb-3" style="padding-left: 18px;"></ul>
    <button onclick="fecharPopupPendencias()" class="btn btn-secondary w-100">Fechar</button>
  </div>
   <script src="../js/cadastroClientes.js" defer></script>
  <script src="../js/validarToken.js" defer></script>
  <script src="../js/sair.js" defer></script>
  <!-- SCRIPTS -->
  <script src="../js/validarToken.js" defer></script>
  <script src="../js/auth.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script src="../js/preencher.js" defer></script>

  <script src="../js/formularioOrcamento.js" defer></script>
  <script src="../js/tabelas.js" defer></script>
  <script src="../js/produtos.js" defer></script>
  <!-- Scripts principais (em ordem l√≥gica e sem duplicatas) -->
  <script src="../js/clienteAutocomplete.js" defer></script>
  <script src="../js/consultaCEP.js" defer></script>

  <script src="../js/BarraPesquisa.js" defer></script>


  <script src="../js/equipeInterna.js" defer></script>
  <script src="../js/prazosCondicoes.js" defer></script>

  <script src="../js/formulas.js" defer></script>

  <script src="../js/imprimir.js" defer></script>
  <script src="../js/enviarPropostas.js" defer></script>
  <script src="../js/carregamento.js" defer></script>
  <script src="../js/formularioOrcamento.js" defer></script>
  <script src="../js/formulaValores.js" defer></script>
  <script src="../js/salvarPropostas.js" defer></script>
  <script src="../js/carregamento.js" defer></script>
 
  <script src="../js/envioOmie.js" defer></script>
  <script src="../js/totais.js" defer></script>
  <script src="../js/conferencia.js" defer></script>
  <script>
    function fecharTodasSanfonas() {
      document.querySelectorAll(".accordion-button").forEach(botao => {
        if (!botao.classList.contains("collapsed")) {
          botao.click();
        }
      });
    }
    function abrirTodasSanfonas() {
      document.querySelectorAll(".accordion-button").forEach(botao => {
        if (botao.classList.contains("collapsed")) {
          botao.click();
        }
      });
    }



  </script>

<script>

  
  function abrirTodasSanfonas() {
    document.querySelectorAll(".accordion-button").forEach(botao => {
      if (botao.classList.contains("collapsed")) {
        botao.click();
      }
    });
  }








  
  // Aplica prote√ß√£o de clique duplo em todos os bot√µes com a classe .sidebar-button
// Aplica prote√ß√£o de clique duplo em todos os bot√µes com a classe .sidebar-button
document.querySelectorAll('.sidebar-button').forEach(btn => {
  btn.addEventListener('click', function(evt) {
    if (btn.disabled) {
      console.warn('Clique duplo detectado e bloqueado em:', btn); // Aviso no console
      evt.stopImmediatePropagation();
      evt.preventDefault();
      return false;
    }
    console.log('Clique aceito, bloqueando bot√£o por 2 segundos:', btn); // Log para clique normal
    btn.disabled = true;
    setTimeout(() => btn.disabled = false, 2000); // 2 segundos
  }, true); // true = captura antes do onclick
});


</script>


<script>
  // ==========================
// Configura√ß√µes
// ==========================
// Pega o nome do usu√°rio salvo no localStorage (ou "Usu√°rio Desconhecido" se n√£o existir)
window.usuarioNome = localStorage.getItem("usuarioNome") || "Usu√°rio Desconhecido";

const historicoMudancas = [];
const LIMITE_HISTORICO = 50;

// ==========================
// Registrar altera√ß√µes
// ==========================
function registrarAlteracao(campo, origem = "usuario/js") {
  const usuario = window.usuarioNome || "Usu√°rio Desconhecido";

  // ====== Ignorar campos espec√≠ficos ======
  if (campo.id === "buscaProduto") return; // <<< ignora campo de busca

  const nomeCampo =
    campo.name ||
    campo.id ||
    campo.getAttribute("placeholder") ||
    campo.getAttribute("aria-label") ||
    campo.closest("td")?.innerText?.trim() ||
    "Campo sem identifica√ß√£o";

  const valorOriginal = campo.dataset?.valorOriginal ?? "";
  const valorAtual = campo.value ?? campo.textContent ?? "";

  // ====== Regras para ignorar ======
  if (
    (!valorOriginal && !valorAtual) ||              // vazio ‚Üí vazio
    (valorOriginal === "-" && valorAtual === "-") || // tra√ßo ‚Üí tra√ßo
    (nomeCampo === "Campo sem identifica√ß√£o") ||     // campo n√£o identificado
    (origem === "inclusao-tabela")                   // inclus√£o de tabela (j√° tem log pr√≥prio)
  ) {
    return;
  }

  // S√≥ registra se houve mudan√ßa real
  if (valorOriginal !== valorAtual) {
    const registro = {
      usuario,
      acao: "Altera√ß√£o de campo",
      campo: nomeCampo,
      valorOriginal: valorOriginal || "(vazio)",
      valorAjustado: valorAtual || "(vazio)",
      origem,
      dataHora: new Date().toLocaleString()
    };

    historicoMudancas.push(registro);
    if (historicoMudancas.length > LIMITE_HISTORICO) historicoMudancas.shift();

    console.log(
      `‚úèÔ∏è ${registro.usuario} | Campo: ${registro.campo} | ${registro.valorOriginal} ‚ûù ${registro.valorAjustado}`
    );
  }
}



function registrarInclusaoTabela(idTabela) {
  const usuario = window.usuarioNome || "Usu√°rio Desconhecido";

  const registro = {
    usuario,
    acao: "Inclus√£o de tabela",
    tabela: idTabela,
    dataHora: new Date().toLocaleString()
  };

  historicoMudancas.push(registro);
  if (historicoMudancas.length > LIMITE_HISTORICO) historicoMudancas.shift();

  console.log(`üìë ${usuario} | Tabela inclu√≠da: ${idTabela}`);
}

// ==========================
// Eventos globais
// ==========================
document.addEventListener("focusin", e => {
  const campo = e.target.closest("input, select, textarea, [contenteditable='true']");
  if (campo) campo.dataset.valorOriginal = campo.value ?? campo.textContent;
});

document.addEventListener(
  "blur",
  e => {
    const campo = e.target.closest("input, select, textarea, [contenteditable='true']");
    if (campo) registrarAlteracao(campo, "usuario");
  },
  true
);

// Detecta inclus√£o de tabelas dinamicamente
const observer = new MutationObserver(mutations => {
  for (const m of mutations) {
    m.addedNodes.forEach(node => {
      if (node.nodeType === 1 && node.matches("table[id^='tabela-bloco-']")) {
        registrarInclusaoTabela(node.id);
      }
      if (node.nodeType === 1) {
        const tabelas = node.querySelectorAll("table[id^='tabela-bloco-']");
        tabelas.forEach(tbl => registrarInclusaoTabela(tbl.id));
      }
    });
  }
});
observer.observe(document.body, { childList: true, subtree: true });

// ==========================
// UI - Bot√£o e Tabela Hist√≥rico
// ==========================
function toggleTabelaHistorico() {
  let tabelaDiv = document.getElementById("historico-mudancas-div");
  const btn = document.getElementById("btn-historico-mudancas");

  // Se ainda n√£o existe a tabela ‚Üí cria
  if (!tabelaDiv) {
    tabelaDiv = document.createElement("div");
    tabelaDiv.id = "historico-mudancas-div";
    tabelaDiv.className = "mt-3";
    btn.parentNode.appendChild(tabelaDiv);
    btn.textContent = "üîÑ Atualizar Hist√≥rico"; // muda o texto do bot√£o
  }

  // Atualiza o conte√∫do SEM remover a div
  let html = `
    <div class="card shadow-sm">
      <div class="card-header fw-bold d-flex justify-content-between align-items-center">
        Hist√≥rico de Altera√ß√µes (m√°x. ${LIMITE_HISTORICO})
      
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-bordered table-sm mb-0">
            <thead class="table-light">
              <tr>
                <th>Usu√°rio</th>
                <th>A√ß√£o</th>
                <th>Campo/Tabela</th>
                <th>Original</th>
                <th>Ajustado</th>
                <th>Data/Hora</th>
              </tr>
            </thead>
            <tbody>
              ${
                historicoMudancas.length === 0
                  ? `<tr><td colspan="6" class="text-center text-muted">Nenhuma altera√ß√£o registrada</td></tr>`
                  : historicoMudancas
                      .map(r => `
                        <tr>
                          <td>${r.usuario}</td>
                          <td>${r.acao}</td>
                          <td>${r.campo || r.tabela || "-"}</td>
                          <td>${r.valorOriginal || "-"}</td>
                          <td>${r.valorAjustado || "-"}</td>
                          <td>${r.dataHora}</td>
                        </tr>
                      `)
                      .join("")
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;

  tabelaDiv.innerHTML = html;
}

// ==========================
// Fun√ß√µes utilit√°rias
// ==========================
function verHistoricoMudancas() {
  if (historicoMudancas.length === 0) {
    console.warn("Nenhuma altera√ß√£o registrada ainda.");
  } else {
    console.table(historicoMudancas);
  }
}

function limparHistoricoMudancas() {
  historicoMudancas.length = 0;
  console.info("Hist√≥rico de mudan√ßas limpo.");
  const div = document.getElementById("historico-mudancas-div");
  if (div) toggleTabelaHistorico(); // atualiza
}

</script>

</body>

</html>
